# Ручное создание загрузочной UEFI-флешки

Стандарт UEFI [изначально назывался EFI](https://ru.wikipedia.org/wiki/Extensible_Firmware_Interface).
В [спецификации](https://uefi.org/specifications) используются оба названия.

Чтобы сделать флешку загрузочной, нужно:
1. Создать на ней таблицу разделов GPT
2. Создать раздел с файловой системой FAT32
3. Поместить загрузчик по пути `efi\boot\bootx64.efi`

Прошивка материнки знает файловые системы FAT12/16/32 и запускает загрузчик.
Загрузчик в свою очередь запускает ядро (т.е. должен знать ext4 и другие необходимые файловые системы).

## Подготовка

1\. Втыкаем флешку

2\. Выясняем [файл устройства](https://ru.wikipedia.org/wiki/Специальный_файл_устройства):

```
sudo fdisk -l
```

У меня это `/dev/sde`.

3\. Отмонтируем все разделы флешки (`/dev/sde1`, `/dev/sde2`, ...), если примонтированы:

```
umount /dev/sde?*
```

## Создаём файловую систему на флешке

1\. Запускаем утилиту для интерактивного редактирования диска (**не перепутайте устройство!**): 

```
sudo fdisk /dev/sde
```

В случае чего можно ввести `q` для выхода без записи изменений на диск.

2\. Вводим `g` для создания новой пустой таблицы разделов GPT

3\. Вводим `n` для создания нового раздела

4\. Жмём `Enter`, чтобы использовать дефолтный номер раздела (первый)

5\. Жмём `Enter`, чтобы использовать дефолтный первый сектор (начало флешки)

6\. Жмём `Enter`, чтобы использовать дефолтный последний сектор (конец флешки)

Может возникнуть предупреждение, что на флешке уже есть сигнатура какой-то файловой системы. Соглашаемся на удаление.

7\. Вводим `t` для изменения типа раздела, а затем вводим `Microsoft basic data`

Вообще в спецификации указано, что у раздела должен быть тип `EFI System` с GUID `c12a7328-f81f-11d2-ba4b-00a0c93ec93b`.
Но такой раздел не автомонтируется в Linux и не отображается как диск в Windows.
Поэтому удобнее использовать тип `Microsoft basic data` с GUID `ebd0a0a2-b9e5-4433-87c0-68b6b72699c7`.
Тип раздела можно менять туда и обратно без потери данных.

8\. Вводим `w` для записи изменений на диск и выхода из fdisk

9\. Форматируем раздел:

```
sudo mkfs.fat -F 32 /dev/sde1
```

## Копируем данные на флешку

1\. Качаем образ Live USB любого дистрибутива (например [Linux Mint](https://www.linuxmint.com/download.php))

Только Manjaro не качайте - там испорченный загрузчик
([1](https://forum.manjaro.org/t/the-iso-files-have-not-been-made-compatible-with-iso-file-copy-mode/77394),
[2](https://github.com/pbatard/rufus/wiki/FAQ#GRUB)).

2\. Монтируем iso от обычного пользователя:

```
udisksctl loop-setup -r -f linuxmint-21.3-cinnamon-64bit.iso
```

[Тут](https://wiki.archlinux.org/title/udisks) подробнее об использовании udisks.

Не используйте для распаковки архиваторы вроде 7z, так как на iso могут быть символические ссылки.

3\. Монтируем флешку от обычного пользователя:

```
udisksctl mount -b /dev/sde1
```

4\. Копируем файлы из iso на флешку

Теперь с неё можно загружаться!

## EndeavourOS

EndeavourOS монтирует флешку по метке (в моём случае использует путь `/dev/disk/by-label/EOS_202404`),
поэтому не забудьте установить для флешки правильную метку:

1\. Размонтируем флешку, чтобы не было проблем:

```
umount /dev/sde?*
```

2\. Меняем метку:

```
sudo fatlabel /dev/sde1 EOS_202404
```
